# Ad Service Dockerfile – Explanation

This Dockerfile uses a multi-stage build to compile a Java-based microservice using Gradle and then produce a lightweight runtime image.

## Stage 1: Build Stage (Java + Gradle Build Environment)
`FROM eclipse-temurin:21-jdk AS builder`
- Uses Temurin JDK 21 as the base image.
- This stage compiles the Java application.

`WORKDIR /usr/src/app/`
- Sets the working directory inside the container where all files will be stored.

```hcl
COPY gradlew* settings.gradle* build.gradle .
COPY ./gradle ./gradle
```
- Copies the Gradle wrapper scripts (gradlew)
- Copies Gradle configurations (settings.gradle, build.gradle)
- Copies the gradle/ internal directory
- These files are required before copying source code so Docker caching works efficiently.

```hcl
RUN chmod +x ./gradlew
RUN ./gradlew
RUN ./gradlew downloadRepos
```
- Makes gradlew executable
- Runs a basic Gradle build
- downloadRepos pre-downloads Gradle dependencies to speed up the build

```hcl
COPY . .
COPY ./pb ./proto
```
- Copies the source code into the container
- Copies protobuf files (pb) into a folder named proto
- This service likely generates gRPC or protobuf classes during build

```hcl
RUN chmod +x ./gradlew
RUN ./gradlew installDist -PprotoSourceDir=./proto
```
- Makes Gradle executable again (after copying code)
- installDist builds the application and produces a standalone runnable distribution inside build/install/
- -PprotoSourceDir=./proto tells Gradle where to find protobuf files

## Stage 2: Runtime Stage (Lightweight JRE Image)
`FROM eclipse-temurin:21-jre`
- Uses a smaller Java Runtime Environment (JRE only)
- Reduces final image size
- Application runs faster in a minimal runtime

`WORKDIR /usr/src/app/`
- Sets runtime working directory

`COPY --from=builder /usr/src/app/ ./`
- Copies the built application output from the builder stage
- Only the compiled code and required files are copied
- Avoids source code, unnecessary build tools → keeps image small

`ENV AD_PORT 9099`
- Exposes app port 9099 via environment variable
- Useful for Kubernetes or Docker configuration

`ENTRYPOINT ["./build/install/opentelemetry-demo-ad/bin/Ad"]`
- Defines the entrypoint (the command that runs when container starts)
- Runs the compiled Ad service executable generated by Gradle

